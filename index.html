<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Checkmate in 1 Trainer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
</head>
<body class="bg-slate-950" style="background: linear-gradient(135deg, #8b6b93 0%, #0f172a 75%);">

<div class="text-white grid place-items-center m-8">
    <h1 id="title" class="text-4xl">Chess Puzzle Trainer</h1>
    <div id="myBoard" style="width: 50%; max-width: 400px;"></div>
    <p id="solution"></p>
    <p id="hintText" class="text-yellow-300 text-xl"></p>
    <p id="feedbackText" class="text-3xl font-bold transition-opacity duration-300" style="min-height: 2.5rem;"></p>
    <p id="cr">Correct: 0</p>
    <p id="strikes">Strikes: 0</p>
    <p id="timeLeft"></p>
    <div>
        <button id="startButton" onclick="startPuzzle()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-4xl">Start</button>
        <button id="hintButton" onclick="showHint()" class="bg-yellow-500 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded text-2xl" style="display:none; margin-left:10px;">Hint</button>
    </div>
</div>

<!-- Game Over Modal -->
<div id="gameOverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="display:none; z-index:9999;">
    <div class="bg-white rounded-lg p-8 text-center w-11/12 max-w-md">
        <h2 class="text-3xl font-bold mb-4 text-black">Game Over</h2>
        <p id="modalStats" class="text-lg text-gray-800 mb-6"></p>
        <div class="flex justify-center gap-4">
            <button id="restartBtn" onclick="restartGame()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Restart</button>
            <button id="closeBtn" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Close</button>
        </div>
    </div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
<script>
    // puzzles gotten from https://github.com/denialromeo/4462-chess-problems/blob/master/problems.json
    var board = null;
    var game = new Chess();

    const title = $("#title");
    const solution = $("#solution");
    const correctText = $("#cr");
    const strikText = $("#strikes");
    const timeLeftText = $("#timeLeft");
    const feedbackText = $("#feedbackText");

    var correct = 0;
    var config = {
        draggable: true,
        pieceTheme: 'img/{piece}.png',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
    };

    board = Chessboard('myBoard', config);
    $(window).resize(board.resize)

    solution.hide();

    var timeLimit = 180; 
    var timer;
    var strikes = 0;
    var maxStrikes = 3;
    var timeLeft = timeLimit;
    var hintClicks = 0;

    jQuery('#myBoard').on('scroll touchmove touchend touchstart contextmenu', function(e){
        e.preventDefault();
    });

    function updateTimerDisplay() {
        var minutes = Math.floor(timeLeft / 60);
        var seconds = timeLeft % 60;
        var timeDisplay = String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');
        timeLeftText.text(`Time Left: ${timeDisplay}`);
    }

    function disableBoardInteractions() {
        config.draggable = false;
    }

    function newPuzzle() {
        $.getJSON('puzzles.json', function(data) {
            var index = Math.floor(Math.random() * 301);
            var problem = data['problems'][index];

            board.position(problem['fen']);
            game.load(problem['fen']);
            title.text("#" + problem['problemid'] + ": " + problem['type']);
            solution.text(problem['moves']);
            // reset hint state for each new puzzle
            hintClicks = 0;
            $('#hintButton').text('Hint').show();
            $('#hintText').text('');
            solution.hide();
            clearHighlights();
        });
    }

    function onDragStart(source, piece, position, orientation) {
        if (game.game_over()) return false;

        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
            return false;
        }
    }

    function onDrop(source, target) {
        var move = game.move({
            from: source,
            to: target,
            promotion: 'q'
        });

        if (move === null) return 'snapback';

        var moveAN = move.from + '-' + move.to;
        var solutionMoves = solution.text().split(' ');

        if (!solutionMoves.includes(moveAN)) {  
            showFeedback('✗ Wrong!', 'text-red-500');
            strikes++;
            strikText.text(`Strikes: ${strikes}`);
            // if reached max strikes, end game, else load a new puzzle
            if (strikes >= maxStrikes) {
                setTimeout(() => endGame('Maximum strikes reached'), 800);
            } else {
                setTimeout(() => newPuzzle(), 800);
            }
        } else {
            showFeedback('✓ Correct!', 'text-green-500');
            correct++;
            correctText.text(`Correct: ${correct}`);
            setTimeout(() => newPuzzle(), 800);
        }
    }

    function onSnapEnd() {
        board.position(game.fen());
    }

    function startPuzzle() {
        document.getElementById("startButton").style.display = "none"; 
        correct = 0;
        strikes = 0;
        timeLeft = timeLimit;
        startTimer();
        enableBoardInteractions(); 
        newPuzzle();
    }

    function startTimer() {
        timeLeft = timeLimit;
        updateTimerDisplay();

        timer = setInterval(function () {
            timeLeft--;
            updateTimerDisplay();

            if (timeLeft <= 0 || strikes >= maxStrikes) {
                clearInterval(timer);
                endGame('Time is up!');
            }
        }, 1000);
    }

    function enableBoardInteractions() {
        config.draggable = true;
    }

    function showFeedback(message, colorClass) {
        feedbackText.text(message);
        feedbackText.removeClass('text-red-500 text-green-500').addClass(colorClass);
        feedbackText.css('opacity', '1');
        
        setTimeout(() => {
            feedbackText.css('opacity', '0');
        }, 600);
    }

    // Clear any square highlights added by hints
    function clearHighlights() {
        // chessboard.js uses data-square attributes on square divs
        $('[data-square]').each(function() {
            $(this).css('background', '');
        });
    }

    function highlightSquare(square, color) {
        color = color || 'rgba(250, 204, 21, 0.6)'; // yellow by default
        var sq = $('[data-square="' + square + '"]');
        if (sq.length) {
            sq.css('background', color);
        }
    }

    // Show a two-step hint: first click -> show which piece to move (square), second click -> reveal solution
    function showHint() {
        var movesText = solution.text();
        if (!movesText) return;

        hintClicks++;
        var solutionMoves = movesText.split(' ');
        var firstMove = solutionMoves[0] || '';
        var parts = firstMove.split('-');
        var from = parts[0] || '';
        var to = parts[1] || '';

        if (hintClicks === 1) {
            // show starting square location and highlight it
            $('#hintText').text('Hint: move the piece at ' + from);
            clearHighlights();
            highlightSquare(from, 'rgba(250, 204, 21, 0.7)');
            $('#hintButton').text('Show Solution');
        } else {
            // reveal full solution and highlight from/to
            solution.show();
            $('#hintText').text('');
            clearHighlights();
            if (from) highlightSquare(from, 'rgba(16, 185, 129, 0.6)');
            if (to) highlightSquare(to, 'rgba(248, 113, 113, 0.6)');
            $('#hintButton').hide();
        }
    }

    // End the game and show the modal with optional message
    function endGame(message) {
        clearInterval(timer);
        disableBoardInteractions();
        // hide hint button
        $('#hintButton').hide();
        // populate modal stats
        $('#modalStats').html('<strong>' + (message || 'Game over') + '</strong><br/>Correct: ' + correct + '<br/>Strikes: ' + strikes);
        $('#gameOverModal').show();
    }

    function closeModal() {
        $('#gameOverModal').hide();
    }

    function restartGame() {
        // Reset counters and UI, then immediately start a new game
        clearInterval(timer);
        correct = 0;
        strikes = 0;
        correctText.text(`Correct: ${correct}`);
        strikText.text(`Strikes: ${strikes}`);
        timeLeft = timeLimit;
        updateTimerDisplay();
        $('#gameOverModal').hide();
        $('#hintText').text('');
        $('#hintButton').hide();
        solution.hide();
        clearHighlights();
        // reset hint state
        hintClicks = 0;
        // start a fresh game immediately
        startPuzzle();
    }
</script>
</body>
</html>
