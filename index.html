<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mate-in-One Trainer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .pulse-once { animation: pulseOnce 0.6s ease-out; }
        @keyframes pulseOnce { 0%{transform:scale(.96);opacity:.0}40%{transform:scale(1);opacity:1}100%{transform:scale(1);opacity:0} }
        .fade-in { animation: fadeIn .5s ease; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(8px);} to { opacity:1; transform: translateY(0);} }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-violet-700 via-slate-800 to-slate-950 text-slate-100 flex flex-col">
<header class="w-full py-6 px-6 md:px-10 flex items-center justify-between">
    <h1 class="text-3xl md:text-4xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-amber-300 via-yellow-200 to-white drop-shadow-sm">Chess Puzzle Trainer</h1>
    <nav class="hidden md:flex gap-4 text-sm font-medium text-slate-300">
        <span class="opacity-70">Mate in 1 Practice</span>
    </nav>
</header>

<main class="flex-1 w-full max-w-6xl mx-auto px-5 pb-16">
    <div class="grid lg:grid-cols-2 gap-8 lg:gap-12 items-start">
        <!-- Board Card -->
        <div class="glass rounded-xl p-5 md:p-6 shadow-xl shadow-slate-900/40 fade-in">
            <div class="relative mx-auto" style="max-width:420px; width:100%;">
                <div id="myBoard"></div>
                <div id="boardOverlay" class="absolute inset-0 flex items-center justify-center bg-slate-900/70 text-slate-200 text-lg font-semibold tracking-wide select-none">
                    Press Start to Begin
                </div>
            </div>
            <div class="mt-4 flex flex-wrap gap-3 items-center justify-center">
                <button id="startButton" onclick="startPuzzle()" class="bg-indigo-500 hover:bg-indigo-600 active:bg-indigo-700 transition-colors text-white font-semibold py-2.5 px-6 rounded-lg text-lg shadow focus:outline-none focus:ring-2 focus:ring-indigo-400">Start</button>
                <button id="hintButton" onclick="showHint()" class="bg-amber-400 hover:bg-amber-500 active:bg-amber-600 text-slate-900 font-semibold py-2.5 px-6 rounded-lg text-lg shadow focus:outline-none focus:ring-2 focus:ring-amber-300" style="display:none;">Hint</button>
            </div>
            <p id="feedbackText" class="text-center text-3xl font-bold mt-4 h-10 select-none"></p>
            <p id="hintText" class="text-center text-amber-300 text-lg font-medium min-h-[1.75rem]"></p>
        </div>

        <!-- Stats / Info Card -->
        <div class="space-y-6">
            <div class="glass rounded-xl p-6 shadow-xl shadow-slate-900/40 fade-in">
                <h2 class="text-xl font-semibold mb-4 tracking-wide text-slate-200">Session</h2>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-slate-900/40 rounded-lg py-4">
                        <p class="text-xs uppercase tracking-wider text-slate-400">Correct</p>
                        <p id="cr" class="text-lg font-semibold text-emerald-400">Correct: 0</p>
                    </div>
                    <div class="bg-slate-900/40 rounded-lg py-4">
                        <p class="text-xs uppercase tracking-wider text-slate-400">Strikes</p>
                        <p id="strikes" class="text-lg font-semibold text-rose-400">Strikes: 0</p>
                    </div>
                </div>
                <div class="mt-5">
                    <p id="timeLeft" class="text-center text-lg font-medium text-slate-200"></p>
                </div>
                <div class="mt-6 border-t border-slate-700/50 pt-4">
                    <p class="text-xs leading-relaxed text-slate-400">Drag the correct mating move. You have <span class="font-semibold">3 strikes</span> and a <span class="font-semibold">3 minute</span> timer. Use a hint if stuck (first shows the piece, second reveals solution).</p>
                </div>
                <p id="solution" class="mt-3 text-center text-emerald-300 font-mono text-sm"></p>
            </div>
        </div>
    </div>
</main>

<footer class="mt-auto py-6 text-center text-xs text-slate-500">
    <p>Practice makes progress. ♟️ Built for study.</p>
    <p class="mt-2 text-[11px] tracking-wide text-slate-400">© 2025 <a href="https://github.com/charleskhervie" target="_blank" rel="noopener" class="font-semibold text-slate-300 hover:text-amber-300 transition-colors">Charles Khervie Realino</a></p>
</footer>

<!-- Game Over Modal -->
<div id="gameOverModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm flex items-center justify-center" style="display:none; z-index:60;">
    <div class="glass border border-slate-700/40 rounded-2xl p-8 md:p-10 text-center w-11/12 max-w-md shadow-2xl shadow-black/50">
        <h2 class="text-3xl font-bold mb-3 tracking-tight text-rose-300">Game Over</h2>
        <p id="modalStats" class="text-base text-slate-200 mb-6 leading-relaxed"></p>
        <div class="flex flex-wrap justify-center gap-4">
            <button id="restartBtn" onclick="restartGame()" class="bg-emerald-500 hover:bg-emerald-600 active:bg-emerald-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow focus:outline-none focus:ring-2 focus:ring-emerald-400">Restart</button>
            <button id="closeBtn" onclick="closeModal()" class="bg-slate-300 hover:bg-slate-200 active:bg-slate-400 text-slate-900 font-semibold py-2.5 px-6 rounded-lg shadow focus:outline-none focus:ring-2 focus:ring-slate-300">Close</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
<script>
    // puzzles gotten from https://github.com/denialromeo/4462-chess-problems/blob/master/problems.json
    var board = null;
    var game = new Chess();

    const title = $("#title"); // (retained for potential future use)
    const solution = $("#solution");
    const correctText = $("#cr");
    const strikText = $("#strikes");
    const timeLeftText = $("#timeLeft");
    const feedbackText = $("#feedbackText");

    var correct = 0;
    var config = {
        draggable: true,
        pieceTheme: 'img/{piece}.png',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
    };

    board = Chessboard('myBoard', config);
    $(window).resize(board.resize)

    solution.hide();

    var timeLimit = 180; 
    var timer;
    var strikes = 0;
    var maxStrikes = 3;
    var timeLeft = timeLimit;
    var hintClicks = 0;

    jQuery('#myBoard').on('scroll touchmove touchend touchstart contextmenu', function(e){
        e.preventDefault();
    });

    function updateTimerDisplay() {
        var minutes = Math.floor(timeLeft / 60);
        var seconds = timeLeft % 60;
        var timeDisplay = String(minutes).padStart(2, '0') + ":" + String(seconds).padStart(2, '0');
        timeLeftText.text(`Time Left: ${timeDisplay}`);
    }

    function disableBoardInteractions() {
        config.draggable = false;
        // re-init board to apply non-draggable state
        board = Chessboard('myBoard', { ...config, position: game.fen() });
    }

    function newPuzzle() {
        $.getJSON('puzzles.json', function(data) {
            var index = Math.floor(Math.random() * 301);
            var problem = data['problems'][index];

            board.position(problem['fen']);
            game.load(problem['fen']);
            title.text("#" + problem['problemid'] + ": " + problem['type']);
            solution.text(problem['moves']);
            // reset hint state for each new puzzle
            hintClicks = 0;
            $('#hintButton').text('Hint').show();
            $('#hintText').text('');
            solution.hide();
            clearHighlights();
        });
    }

    function onDragStart(source, piece, position, orientation) {
        if (game.game_over()) return false;

        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
            return false;
        }
    }

    function onDrop(source, target) {
        var move = game.move({
            from: source,
            to: target,
            promotion: 'q'
        });

        if (move === null) return 'snapback';

        var moveAN = move.from + '-' + move.to;
        var solutionMoves = solution.text().split(' ');

        if (!solutionMoves.includes(moveAN)) {  
            showFeedback('✗ Wrong!', 'text-red-500');
            strikes++;
            strikText.text(`Strikes: ${strikes}`);
            // if reached max strikes, end game, else load a new puzzle
            if (strikes >= maxStrikes) {
                setTimeout(() => endGame('Maximum strikes reached'), 800);
            } else {
                setTimeout(() => newPuzzle(), 800);
            }
        } else {
            showFeedback('✓ Correct!', 'text-green-500');
            correct++;
            correctText.text(`Correct: ${correct}`);
            setTimeout(() => newPuzzle(), 800);
        }
    }

    function onSnapEnd() {
        board.position(game.fen());
    }

    function startPuzzle() {
        $('#startButton').hide();
        $('#boardOverlay').fadeOut(200);
        correct = 0;
        strikes = 0;
        timeLeft = timeLimit;
        correctText.text(`Correct: ${correct}`);
        strikText.text(`Strikes: ${strikes}`);
        startTimer();
        enableBoardInteractions(); 
        newPuzzle();
    }

    function startTimer() {
        timeLeft = timeLimit;
        updateTimerDisplay();

        timer = setInterval(function () {
            timeLeft--;
            updateTimerDisplay();

            if (timeLeft <= 0 || strikes >= maxStrikes) {
                clearInterval(timer);
                endGame('Time is up!');
            }
        }, 1000);
    }

    function enableBoardInteractions() {
        config.draggable = true;
        board = Chessboard('myBoard', { ...config, position: game.fen() });
    }
    function showStartScreen() {
        disableBoardInteractions();
        game.reset();
        board = Chessboard('myBoard', { ...config, position: 'start' });
        correct = 0;
        strikes = 0;
        correctText.text(`Correct: ${correct}`);
        strikText.text(`Strikes: ${strikes}`);
        $('#boardOverlay').show();
        $('#startButton').show();
        $('#hintButton').hide();
        $('#solution').hide();
        $('#hintText').text('');
        $('#feedbackText').text('');
        timeLeft = timeLimit;
        updateTimerDisplay();
    }

    function showFeedback(message, colorClass) {
        feedbackText.text(message);
        feedbackText.removeClass('text-red-500 text-green-500').addClass(colorClass + ' pulse-once');
        setTimeout(() => {
            feedbackText.text('');
            feedbackText.removeClass('pulse-once');
        }, 750);
    }

    // Clear any square highlights added by hints
    function clearHighlights() {
        // chessboard.js uses data-square attributes on square divs
        $('[data-square]').each(function() {
            $(this).css('background', '');
        });
    }

    function highlightSquare(square, color) {
        color = color || 'rgba(250, 204, 21, 0.6)'; // yellow by default
        var sq = $('[data-square="' + square + '"]');
        if (sq.length) {
            sq.css('background', color);
        }
    }

    // Show a two-step hint: first click -> show which piece to move (square), second click -> reveal solution
    function showHint() {
        var movesText = solution.text();
        if (!movesText) return;

        hintClicks++;
        var solutionMoves = movesText.split(' ');
        var firstMove = solutionMoves[0] || '';
        var parts = firstMove.split('-');
        var from = parts[0] || '';
        var to = parts[1] || '';

        if (hintClicks === 1) {
            // show starting square location and highlight it
            $('#hintText').text('Hint: move the piece at ' + from);
            clearHighlights();
            highlightSquare(from, 'rgba(250, 204, 21, 0.7)');
            $('#hintButton').text('Show Solution');
        } else {
            // reveal full solution and highlight from/to
            solution.show();
            $('#hintText').text('');
            clearHighlights();
            if (from) highlightSquare(from, 'rgba(16, 185, 129, 0.6)');
            if (to) highlightSquare(to, 'rgba(248, 113, 113, 0.6)');
            $('#hintButton').hide();
        }
    }

    // End the game and show the modal with optional message
    function endGame(message) {
        clearInterval(timer);
        disableBoardInteractions();
        $('#hintButton').hide();
        $('#modalStats').html('<strong class="text-rose-300">' + (message || 'Game over') + '</strong><br/><span class="text-emerald-300 font-medium">Correct:</span> ' + correct + '<br/><span class="text-rose-300 font-medium">Strikes:</span> ' + strikes);
        $('#gameOverModal').fadeIn(250);
    }

    function closeModal() {
        $('#gameOverModal').fadeOut(200, () => {
            showStartScreen();
        });
    }

    function restartGame() {
        clearInterval(timer);
        correct = 0;
        strikes = 0;
        correctText.text(`Correct: ${correct}`);
        strikText.text(`Strikes: ${strikes}`);
        hintClicks = 0;
        $('#gameOverModal').hide();
        startPuzzle();
    }

    // Initialize start screen on load
    $(function(){
        showStartScreen();
    });
</script>
</body>
</html>
